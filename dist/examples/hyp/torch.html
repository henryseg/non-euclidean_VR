<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="../../../images/favicon.png">
    <!-- Style sheets -->
    <link rel="stylesheet" href="../css/style.css">

    <title>Virtual Reality (Relation between tangent space and geometry)</title>
    <!-- Import maps polyfill -->
    <!-- Remove this when import maps will be widely supported -->
    <script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "../jsm/three.module.js",
                "thurstonHyp": "../../build/thurstonHyp.js"
            }
        }
    </script>
</head>
<body>
</body>
<script type="module" id="main">
    import {
        XRControllerModelFactory,
        cubeSet as cube,
        VRRenderer,
        Scene,
        VRCamera,
        Vector,
        Point,
        PointLight,
        PhongMaterial,
        Solid,
        LocalBallShape,
        complement,
        FlyControls,
        InfoControls,
        LightVRControls,
        VaryingColorMaterial,
        PhongWrapMaterial,
    } from "thurstonHyp";
    import {Color, Clock} from "three";


    // initial setup
    const camera = new VRCamera({set: cube});
    camera.maxSteps = 300;
    const scene = new Scene();
    const renderer = new VRRenderer(cube, camera, scene, {}, {
        logarithmicDepthBuffer: true
    });
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);


    const controllerModelFactory = new XRControllerModelFactory();

    const controllerGrip0 = renderer.xr.getControllerGrip(0);
    const model0 = controllerModelFactory.createControllerModel(controllerGrip0);
    controllerGrip0.add(model0);
    renderer.threeScene.add(controllerGrip0);


    const controller0 = renderer.xr.getController(0);
    renderer.threeScene.add(controller0);

    // lights for the Phong material


    const colorWhite = new Color(1,1,1);
    const light = new PointLight(
        new Vector(1, 0, 0),
        colorWhite,
        0.8
    );

    //  yellow light
    const light0 = new PointLight(
        new Vector(1, 0, 0),
        new Color(1, 1, 0),
    );

    // cyan light
    const light1 = new PointLight(
        new Vector(0, 1, -1),
        new Color(0, 1, 1)
    );

    // magenta light
    const light2 = new PointLight(
        new Vector(-1, -1, 1),
        new Color(1, 0, 1)
    );

    const latticeColor = new Color(0.5, 0.8, 0);
    const latticeBaseMat = new VaryingColorMaterial(
        latticeColor,
        new Color(-0.5, 0.3, 0.3)
    );
    const latticeMat = new PhongWrapMaterial(latticeBaseMat, {
        color: latticeColor,
        shininess: 5,
    });


    // Complement of a local ball
    const ball0 = new LocalBallShape(
        new Point(),
        1.02,
    );
    const latticeShape = complement(ball0);
    const lattice = new Solid(latticeShape, latticeMat);


    // Phong shading material
    const mat1 = new PhongMaterial({
        color: new Color(0, 0, 1),
        shininess: 10
    });


    // adding the items to the scene
    scene.add(lattice, light);

    // building there renderer
    renderer.build();

    // event controller on windows resize
    function onWindowResize(event) {
        renderer.setSize(window.innerWidth, window.innerHeight);
        camera.aspect = window.innerWidth / window.innerHeight
        camera.updateProjectionMatrix();
    }

    window.addEventListener("resize", onWindowResize, false);

    const clock = new Clock();
    const flyControls = new FlyControls(camera, 'fr');
    const infoControls = new InfoControls();
    infoControls.action = function () {
        console.log(controller0.matrixWorld.toLog());
    }
    const chaseControls = new LightVRControls(controller0, camera, light);


    // rendering the scene
    function animate() {
        const delta = clock.getDelta();
        flyControls.update(delta);
        chaseControls.chase(renderer.xr);
        renderer.render();
    }

    renderer.setAnimationLoop(animate);
    renderer.checkShader();


</script>
</html>