<!DOCTYPE html>
<html lang="en">
<head>
    <title>three.js webgl - postprocessing</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<div id="container"></div>

<script type="module">

    import * as THREE from '../../js/lib/threejs/build/three.module.js';

    import Stats from '../../js/lib/threejs/examples/jsm/libs/stats.module.js';

    import {EffectComposer} from '../../js/lib/threejs/examples/jsm/postprocessing/EffectComposer.js';
    import {RenderPass} from '../../js/lib/threejs/examples/jsm/postprocessing/RenderPass.js';
    import {ShaderPass} from '../../js/lib/threejs/examples/jsm/postprocessing/ShaderPass.js';
    import {BloomPass} from '../../js/lib/threejs/examples/jsm/postprocessing/BloomPass.js';
    import {FilmPass} from '../../js/lib/threejs/examples/jsm/postprocessing/FilmPass.js';
    import {DotScreenPass} from '../../js/lib/threejs/examples/jsm/postprocessing/DotScreenPass.js';
    import {MaskPass, ClearMaskPass} from '../../js/lib/threejs/examples/jsm/postprocessing/MaskPass.js';
    import {TexturePass} from '../../js/lib/threejs/examples/jsm/postprocessing/TexturePass.js';

    import {BleachBypassShader} from '../../js/lib/threejs/examples/jsm/shaders/BleachBypassShader.js';
    import {ColorifyShader} from '../../js/lib/threejs/examples/jsm/shaders/ColorifyShader.js';
    import {HorizontalBlurShader} from '../../js/lib/threejs/examples/jsm/shaders/HorizontalBlurShader.js';
    import {VerticalBlurShader} from '../../js/lib/threejs/examples/jsm/shaders/VerticalBlurShader.js';
    import {SepiaShader} from '../../js/lib/threejs/examples/jsm/shaders/SepiaShader.js';
    import {VignetteShader} from '../../js/lib/threejs/examples/jsm/shaders/VignetteShader.js';
    import {GammaCorrectionShader} from '../../js/lib/threejs/examples/jsm/shaders/GammaCorrectionShader.js';

    import {GLTFLoader} from '../../js/lib/threejs/examples/jsm/loaders/GLTFLoader.js';

    let container, stats;

    let composerScene, composer1

    let cameraOrtho, cameraPerspective, sceneModel, renderer, mesh, directionalLight;

    const width = window.innerWidth || 2;
    const height = window.innerHeight || 2;

    let halfWidth = width / 2;
    let halfHeight = height / 2;

    let quadBG, quadMask, renderScene;

    const delta = 0.01;

    init();
    animate();

    function init() {

        container = document.getElementById('container');
        cameraOrtho = new THREE.OrthographicCamera(-halfWidth, halfWidth, halfHeight, -halfHeight, -10000, 10000);
        cameraOrtho.position.z = 100;
        cameraPerspective = new THREE.PerspectiveCamera(50, width / height, 1, 10000);
        cameraPerspective.position.z = 900;
        sceneModel = new THREE.Scene();
        // sceneBG = new THREE.Scene();

        //

        directionalLight = new THREE.DirectionalLight(0xffffff);
        directionalLight.position.set(0, -0.1, 1).normalize();
        sceneModel.add(directionalLight);

        const loader = new GLTFLoader();
        loader.load("models/gltf/LeePerrySmith/LeePerrySmith.glb", function (gltf) {
            createMesh(gltf.scene.children[0].geometry, sceneModel, 100);

        });



        renderer = new THREE.WebGLRenderer();
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(width, height);
        renderer.autoClear = false;

        //

        container.appendChild(renderer.domElement);

        //

        stats = new Stats();
        container.appendChild(stats.dom);

        //

        const shaderBleach = BleachBypassShader;
        const shaderSepia = SepiaShader;
        const shaderVignette = VignetteShader;

        const effectBleach = new ShaderPass(shaderBleach);
        const effectSepia = new ShaderPass(shaderSepia);
        const effectVignette = new ShaderPass(shaderVignette);
        const gammaCorrection = new ShaderPass(GammaCorrectionShader);

        effectBleach.uniforms["opacity"].value = 0.95;
        effectSepia.uniforms["amount"].value = 0.9;
        effectVignette.uniforms["offset"].value = 0.95;
        effectVignette.uniforms["darkness"].value = 1.6;

        const effectFilmBW = new FilmPass(0.35, 0.5, 2048, true);

        const effectHBlur = new ShaderPass(HorizontalBlurShader);
        const effectVBlur = new ShaderPass(VerticalBlurShader);
        effectHBlur.uniforms['h'].value = 2 / (width / 2);
        effectVBlur.uniforms['v'].value = 2 / (height / 2);

        const effectColorify1 = new ShaderPass(ColorifyShader);
        const effectColorify2 = new ShaderPass(ColorifyShader);
        effectColorify1.uniforms['color'] = new THREE.Uniform(new THREE.Color(1, 0.8, 0.8));
        effectColorify2.uniforms['color'] = new THREE.Uniform(new THREE.Color(1, 0.75, 0.5));



        const rtParameters = {
            minFilter: THREE.LinearFilter,
            magFilter: THREE.LinearFilter,
            format: THREE.RGBFormat,
            stencilBuffer: true
        };

        const rtWidth = width / 2;
        const rtHeight = height / 2;

        //

        const renderModel = new RenderPass(sceneModel, cameraPerspective);

        renderModel.clear = false;


        const sceneTarget = new THREE.WebGLRenderTarget(rtWidth * 2, rtHeight * 2, rtParameters);
        composerScene = new EffectComposer(renderer, sceneTarget);

        composerScene.addPass(renderModel);
        composerScene.addPass(new TexturePass(sceneTarget.texture));

        renderScene = new TexturePass(composerScene.renderTarget2.texture);
        composer1 = new EffectComposer(renderer, new THREE.WebGLRenderTarget(rtWidth * 2, rtHeight * 2, rtParameters));

        composer1.addPass(renderScene);
        composer1.addPass(gammaCorrection);
        composer1.addPass(effectFilmBW);
        composer1.addPass(effectVignette);


    }


    function createMesh(geometry, scene, scale) {

        const diffuseMap = new THREE.TextureLoader().load("models/gltf/LeePerrySmith/Map-COL.jpg");
        diffuseMap.encoding = THREE.sRGBEncoding;

        const mat2 = new THREE.MeshPhongMaterial({
            color: 0x999999,
            specular: 0x080808,
            shininess: 20,
            map: diffuseMap,
            normalMap: new THREE.TextureLoader().load("models/gltf/LeePerrySmith/Infinite-Level_02_Tangent_SmoothUV.jpg"),
            normalScale: new THREE.Vector2(0.75, 0.75)

        });

        mesh = new THREE.Mesh(geometry, mat2);
        mesh.position.set(0, -50, 0);
        mesh.scale.set(scale, scale, scale);

        scene.add(mesh);

    }

    //

    function animate() {

        requestAnimationFrame(animate);

        stats.begin();
        render();
        stats.end();

    }

    function render() {
        composerScene.render();
        composer1.render();


    }

</script>
</body>
</html>
