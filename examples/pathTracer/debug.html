<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="../../images/favicon.png">
    <!-- Style sheets -->
    <link rel="stylesheet" href="../css/style.css">

    <title>Path tracer, first attempt</title>
</head>
<body>
</body>
<script type="module" id="main">
    import {Color, Matrix4} from "../../js/lib/threejs/build/three.module.js";

    import * as geom from "../../js/geometries/euc/geometry/General.js";
    import trivial from "../../js/commons/groups/trivial/set.js";

    import {PathTracerCamera, PathTracerRenderer, Scene} from "../../js/core/General.js";

    import {BallShape, HalfSpaceShape} from "../../js/geometries/euc/shapes/all.js";
    import {Solid} from "../../js/core/solids/Solid.js";
    import {Isometry, Point} from "../../js/geometries/euc/geometry/General.js";
    import {BasicPTMaterial} from "../../js/commons/material/basicPTMaterial/BasicPTMaterial.js";
    import Stats from "../../js/lib/stats.module.js";
    import {PhongMaterial, SingleColorMaterial} from "../../js/commons/material/all.js";
    import {Ball, HalfSpace} from "../../js/geometries/euc/solids/all.js";

    //------------------------------------------------------------------------------------------------------------------
    // General setup
    //------------------------------------------------------------------------------------------------------------------

    const stats = new Stats();
    stats.showPanel(0);
    document.body.appendChild(stats.dom);

    //------------------------------------------------------------------------------------------------------------------
    // Building the scene
    //------------------------------------------------------------------------------------------------------------------

    const bgColor = new Color(0, 0, 0);
    const scene = new Scene({
        ptMaxBounces: 10,
        background: new SingleColorMaterial(bgColor),
        ptBackground: new BasicPTMaterial({
            diffuse: bgColor,
            specular: bgColor,
        })
    });

    // main ball
    const ballColor = new Color(1, 1, 1);
    const ballMat = new PhongMaterial({color: ballColor});
    const ptBallMat = new BasicPTMaterial({
        diffuse: ballColor,
        specular: ballColor,
        roughness: 0.,
        reflectionChance: 0.01,
        refractionChance: 0,
        diffuseChance: 0.99
    });
    const ball = new Ball(new Point(0, 0, -1), 0.3, ballMat, ptBallMat);
    scene.add(ball);


    // back wall
    const backColor = new Color(1, 0, 0);
    const backPoint = new Point(0, 0, -1.4);
    const backIsom = new Isometry().makeTranslation(backPoint);
    const backMat = new PhongMaterial({color: backColor});
    const ptBackMat = new BasicPTMaterial({
        diffuse: backColor,
        specular: backColor,
        diffuseChance: 1,
        reflectionChance: 0,
        refractionChance: 0
    });
    const back = new HalfSpace(backIsom, backMat, ptBackMat);
    scene.add(back);


    const leftPoint = new Point(-1, 0, 0);
    const leftIsom = new Isometry().makeTranslation(leftPoint);
    leftIsom.matrix.multiply(new Matrix4().makeRotationY(0.5 * Math.PI));
    const leftShape = new HalfSpaceShape(leftIsom);

    const rightPoint = new Point(1, 0, 0);
    const rightIsom = new Isometry().makeTranslation(rightPoint);
    rightIsom.matrix.multiply(new Matrix4().makeRotationY(-0.5 * Math.PI));
    const rightShape = new HalfSpaceShape(rightIsom);

    const bottomPoint = new Point(0, -0.3, 0);
    const bottomIsom = new Isometry().makeTranslation(bottomPoint);
    bottomIsom.matrix.multiply(new Matrix4().makeRotationX(-0.5 * Math.PI));
    const bottomShape = new HalfSpaceShape(bottomIsom);

    const topPoint = new Point(0, 4, 0);
    const topIsom = new Isometry().makeTranslation(topPoint);
    topIsom.matrix.multiply(new Matrix4().makeRotationX(0.5 * Math.PI));
    const topShape = new HalfSpaceShape(topIsom);


    // light
    const lightShape = new BallShape(
        new Point(0, 0.3, -0.5),
        0.2
    )
    const lightMat = new BasicPTMaterial({
        emission: new Color(1, 1, 1),
    })
    const ptLight = new Solid(topShape, lightMat, lightMat);
    scene.add(ptLight);

    // ball


    // back wall


    // left wall
    const leftMat = new BasicPTMaterial({
        diffuse: new Color(0, 1, 0),
        specular: new Color(0, 1, 0)
    });
    const ptLeft = new Solid(leftShape, leftMat, leftMat);
    scene.add(ptLeft);

    // right wall
    const rightMat = new BasicPTMaterial({
        diffuse: new Color(0, 0, 1),
        specular: new Color(0, 0, 1)
    });
    const right = new Solid(rightShape, rightMat, rightMat);
    scene.add(right);

    // bottom wall
    const bottomMat = new BasicPTMaterial({
        diffuse: new Color(1, 1, 1),
        specular: new Color(1, 1, 1),
    });
    const bottom = new Solid(bottomShape, bottomMat, bottomMat);
    scene.add(bottom);


    //------------------------------------------------------------------------------------------------------------------
    // Running the renderer
    //------------------------------------------------------------------------------------------------------------------

    const ptCamera = new PathTracerCamera({set: trivial, maxSteps: 500});
    const ptRenderer = new PathTracerRenderer(geom, trivial, ptCamera, scene, {
        logarithmicDepthBuffer: true
    });

    // building there renderer
    ptRenderer.build();


    // rendering the scene
    function animate() {
        ptRenderer.updateFrameSeed();
        ptRenderer.render();
        stats.update();
    }


    ptRenderer.setPixelRatio(window.devicePixelRatio);
    ptRenderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(ptRenderer.domElement);

    ptRenderer.setAnimationLoop(animate);
    // renderer.checkShader();


</script>
</html>