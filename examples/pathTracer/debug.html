<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="../../images/favicon.png">
    <!-- Style sheets -->
    <link rel="stylesheet" href="../css/style.css">

    <title>Path tracer, first attempt</title>
</head>
<body>
</body>
<script type="module" id="main">
    import {Color, Matrix4} from "../../js/lib/threejs/build/three.module.js";

    import * as geom from "../../js/geometries/euc/geometry/General.js";
    import trivial from "../../js/commons/groups/trivial/set.js";

    import {PathTracerCamera, PathTracerRenderer, Scene} from "../../js/core/General.js";

    import {BallShape, HalfSpaceShape} from "../../js/geometries/euc/shapes/all.js";
    import {Solid} from "../../js/core/solids/Solid.js";
    import {Isometry, Point} from "../../js/geometries/euc/geometry/General.js";
    import {BasicPTMaterial} from "../../js/commons/material/basicPTMaterial/BasicPTMaterial.js";
    import Stats from "../../js/lib/stats.module.js";

    //------------------------------------------------------------------------------------------------------------------
    // General setup
    //------------------------------------------------------------------------------------------------------------------
    const scene = new Scene({
        maxBounces: 10,
        background: new BasicPTMaterial({
            diffuse: new Color(0, 0, 0),
            specular: new Color(0, 0, 0),
        })
    });
    const camera = new PathTracerCamera({set: trivial, maxSteps:500});
    const renderer = new PathTracerRenderer(geom, trivial, camera, scene, {
        logarithmicDepthBuffer: true
    });




    const stats = new Stats();
    stats.showPanel(0);
    document.body.appendChild(stats.dom);

    //------------------------------------------------------------------------------------------------------------------
    // Building the scene
    //------------------------------------------------------------------------------------------------------------------

    const ballShape = new BallShape(
        new Point(0, 0, -1),
        0.3,
    )

    const backPoint = new Point(0, 0, -1.4);
    const backIsom = new Isometry().makeTranslation(backPoint);
    const backShape = new HalfSpaceShape(backIsom);

    const leftPoint = new Point(-1, 0, 0);
    const leftIsom = new Isometry().makeTranslation(leftPoint);
    leftIsom.matrix.multiply(new Matrix4().makeRotationY(0.5 * Math.PI));
    const leftShape = new HalfSpaceShape(leftIsom);

    const rightPoint = new Point(1, 0, 0);
    const rightIsom = new Isometry().makeTranslation(rightPoint);
    rightIsom.matrix.multiply(new Matrix4().makeRotationY(-0.5 * Math.PI));
    const rightShape = new HalfSpaceShape(rightIsom);

    const bottomPoint = new Point(0, -0.3, 0);
    const bottomIsom = new Isometry().makeTranslation(bottomPoint);
    bottomIsom.matrix.multiply(new Matrix4().makeRotationX(-0.5 * Math.PI));
    const bottomShape = new HalfSpaceShape(bottomIsom);

    const topPoint = new Point(0, 4, 0);
    const topIsom = new Isometry().makeTranslation(topPoint);
    topIsom.matrix.multiply(new Matrix4().makeRotationX(0.5 * Math.PI));
    const topShape = new HalfSpaceShape(topIsom);


    // light
    const lightShape = new BallShape(
        new Point(0, 0.3, -0.5),
        0.2
    )
    const lightMat = new BasicPTMaterial({
        emission: new Color(1, 1, 1),
    })
    const ptLight = new Solid(topShape, lightMat);
    scene.add(ptLight);

    // ball
    const ballMat = new BasicPTMaterial({
        diffuse: new Color(1, 1, 1),
        specular: new Color(1, 1, 1),
        roughness:0.,
        reflectionChance: 0.01,
        refractionChance: 0,
        diffuseChance:0.99
    });
    const ball = new Solid(ballShape, ballMat);
    scene.add(ball);

    // back wall
    const backMat = new BasicPTMaterial({
        diffuse: new Color(1, 0, 0),
        specular: new Color(1, 0, 0),
        diffuseChance:1,
        reflectionChance:0,
        refractionChance:0
    });
    const back = new Solid(backShape, backMat);
    scene.add(back);

    // left wall
    const leftMat = new BasicPTMaterial({
        diffuse: new Color(0, 1, 0),
        specular: new Color(0, 1, 0)
    });
    const ptLeft = new Solid(leftShape, leftMat);
    scene.add(ptLeft);

    // right wall
    const rightMat = new BasicPTMaterial({
        diffuse: new Color(0, 0, 1),
        specular: new Color(0, 0, 1)
    });
    const right = new Solid(rightShape, rightMat);
    scene.add(right);

    // bottom wall
    const bottomMat = new BasicPTMaterial({
        diffuse: new Color(1, 1, 1),
        specular: new Color(1, 1, 1),
    });
    const bottom = new Solid(bottomShape, bottomMat);
    scene.add(bottom);


    // building there renderer
    renderer.build();

    //------------------------------------------------------------------------------------------------------------------
    // Running the renderer
    //------------------------------------------------------------------------------------------------------------------


    // rendering the scene
    function animate() {
        renderer.updateFrameSeed();
        renderer.render();
        stats.update();
    }


    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    renderer.setAnimationLoop(animate);
    // renderer.checkShader();


</script>
</html>