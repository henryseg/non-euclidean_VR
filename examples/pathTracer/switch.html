<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="../../images/favicon.png">
    <!-- Style sheets -->
    <link rel="stylesheet" href="../css/style.css">

    <title>Switch between renderers</title>
</head>
<body>
</body>
<script type="module" id="main">
    import {Color, Vector3, WebGLRenderer} from "../../js/lib/threejs/build/three.module.js";

    import * as geom from "../../js/geometries/euc/geometry/General.js";
    import trivial from "../../js/commons/groups/trivial/set.js";

    import {BasicCamera, BasicRenderer, PathTracerCamera, PathTracerRenderer, Scene} from "../../js/core/General.js";

    import {Isometry, Point} from "../../js/geometries/euc/geometry/General.js";
    import {BasicPTMaterial} from "../../js/commons/material/basicPTMaterial/BasicPTMaterial.js";
    import Stats from "../../js/lib/stats.module.js";
    import {
        EarthTexture,
        PathTracerWrapMaterial,
        PhongMaterial,
        SingleColorMaterial
    } from "../../js/commons/material/all.js";
    import {Ball, HalfSpace} from "../../js/geometries/euc/solids/all.js";
    import {ConstDirLight} from "../../js/geometries/euc/lights/all.js";
    import {KeyGenericControls} from "../../js/controls/KeyGenericControls.js";

    //------------------------------------------------------------------------------------------------------------------
    // General setup
    //------------------------------------------------------------------------------------------------------------------

    const stats = new Stats();
    stats.showPanel(0);
    document.body.appendChild(stats.dom);

    const width = window.innerWidth;
    const height = window.innerHeight;


    const RENDER_BASIC = 0;
    const RENDER_PT = 1;

    //------------------------------------------------------------------------------------------------------------------
    // Building the scene
    //------------------------------------------------------------------------------------------------------------------

    const bgColor = new Color(0, 0, 0);
    const scene = new Scene({
        background: new SingleColorMaterial(bgColor),
        ptBackground: new BasicPTMaterial({
            diffuse: bgColor,
            specular: bgColor,
        })
    });

    // main ball
    const earthColor = new Color(1, 1, 1);
    const earthMat = new EarthTexture('../../js');
    const ptEarthMat = new PathTracerWrapMaterial(earthMat, {
        specular: new Color(1, 1, 1),
        roughness: 0.,
        reflectionChance: 0.05,
        refractionChance: 0,
        diffuseChance: 0.95
    });
    const isom = new Isometry().makeTranslation(new Point(0, 0, -1));
    isom.multiply(new Isometry().makeRotationX(0.5 * Math.PI));
    const earth = new Ball(isom, 0.3, earthMat, ptEarthMat);
    scene.add(earth);

    // main ball
    const ballColor = new Color(1, 1, 1);
    const ballMat = new PhongMaterial({color: ballColor});
    const ptBallMat = new BasicPTMaterial({
        diffuse: ballColor,
        specular: ballColor,
        roughness: 0.,
        reflectionChance: 0.01,
        refractionChance: 0,
        diffuseChance: 0.99
    });
    const ball = new Ball(new Point(-0.35, -0.2, -0.85), 0.1, ballMat, ptBallMat);
    scene.add(ball);

    // back wall
    const backColor = new Color(1, 0, 0);
    const backPoint = new Point(0, 0, -1.4);
    const backIsom = new Isometry().makeTranslation(backPoint);
    const backMat = new PhongMaterial({color: backColor});
    const ptBackMat = new BasicPTMaterial({
        diffuse: backColor,
        specular: backColor,
        diffuseChance: 1,
        reflectionChance: 0,
        refractionChance: 0
    });
    const back = new HalfSpace(backIsom, backMat, ptBackMat);
    scene.add(back);

    // left wall
    const leftColor = new Color(0, 1, 0);
    const leftMat = new PhongMaterial({color: leftColor});
    const ptLeftMat = new BasicPTMaterial({
        diffuse: leftColor,
        specular: leftColor
    });
    const leftPoint = new Point(-1, 0, 0);
    const leftIsom = new Isometry().makeTranslation(leftPoint);
    leftIsom.multiply(new Isometry().makeRotationY(0.5 * Math.PI));
    const ptLeft = new HalfSpace(leftIsom, leftMat, ptLeftMat);
    scene.add(ptLeft);

    // right wall
    const rightColor = new Color(0, 0, 1);
    const rightMat = new PhongMaterial({color: rightColor});
    const ptRightMat = new BasicPTMaterial({
        diffuse: rightColor,
        specular: rightColor
    });
    const rightPoint = new Point(1, 0, 0);
    const rightIsom = new Isometry().makeTranslation(rightPoint);
    rightIsom.multiply(new Isometry().makeRotationY(-0.5 * Math.PI));
    const right = new HalfSpace(rightIsom, rightMat, ptRightMat);
    scene.add(right);

    // bottom wall
    const bottomColor = new Color(1, 1, 1);
    const bottomMat = new PhongMaterial({color: bottomColor});
    const ptBottomMat = new BasicPTMaterial({
        diffuse: bottomColor,
        specular: bottomColor,
    });
    const bottomPoint = new Point(0, -0.3, 0);
    const bottomIsom = new Isometry().makeTranslation(bottomPoint);
    bottomIsom.multiply(new Isometry().makeRotationX(-0.5 * Math.PI));
    const bottom = new HalfSpace(bottomIsom, bottomMat, ptBottomMat);
    scene.add(bottom);

    // top wall
    const topColor = new Color(3, 3, 3);
    const topMat = new SingleColorMaterial(topColor);
    const ptTopMat = new BasicPTMaterial({
        emission: topColor,
    })
    const topPoint = new Point(0, 4, 0);
    const topIsom = new Isometry().makeTranslation(topPoint);
    topIsom.multiply(new Isometry().makeRotationX(0.5 * Math.PI));
    const top = new HalfSpace(topIsom, topMat, ptTopMat);
    scene.add(top);

    // light for the basic renderer
    const light = new ConstDirLight(topColor, 0.5, new Vector3(0, 1, 0));
    scene.add(light);

    //------------------------------------------------------------------------------------------------------------------
    // Common Three.js renderer
    //------------------------------------------------------------------------------------------------------------------

    const threeRenderer = new WebGLRenderer({logarithmicDepthBuffer: true});
    threeRenderer.autoClear = false;
    document.body.appendChild(threeRenderer.domElement);

    //------------------------------------------------------------------------------------------------------------------
    // Basic renderer
    //------------------------------------------------------------------------------------------------------------------

    const camera = new BasicCamera({set: trivial, maxSteps: 500});
    const renderer = new BasicRenderer(geom, trivial, camera, scene, {}, threeRenderer);

    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(width, height);

    // building the renderer
    renderer.build();

    //------------------------------------------------------------------------------------------------------------------
    // Path tracer renderer
    //------------------------------------------------------------------------------------------------------------------

    const ptCamera = new PathTracerCamera({set: trivial, maxSteps: 500});
    const ptRenderer = new PathTracerRenderer(geom, trivial, ptCamera, scene, {}, threeRenderer);

    ptRenderer.setPixelRatio(window.devicePixelRatio);
    ptRenderer.setSize(width, height);

    // building the renderer
    ptRenderer.build();

    //------------------------------------------------------------------------------------------------------------------
    // Setting up the switch
    //------------------------------------------------------------------------------------------------------------------

    // constant keeping track of the render used
    let current_render = RENDER_BASIC;
    let justSwitched = false;

    function actionKeyDown() {
        current_render = (current_render + 1) % 2;
        justSwitched = true;
    }

    function actionKeyUp() {
    }

    const controls = new KeyGenericControls('p');
    controls.actionKeyDown = actionKeyDown;
    controls.actionKeyUp = actionKeyUp;

    function animate() {
        if (justSwitched) {
            if (current_render === RENDER_PT) {
                ptRenderer.iFrame = 0;
                threeRenderer.setRenderTarget(ptRenderer.accReadTarget);
                threeRenderer.clear();
            }
            justSwitched = false;
        }
        switch (current_render) {
            case RENDER_BASIC:
                renderer.render();
                break;
            case RENDER_PT:
                ptRenderer.updateFrameSeed();
                ptRenderer.render();
                break;
            default:
        }
        stats.update();
    }

    threeRenderer.setAnimationLoop(animate);


</script>
</html>